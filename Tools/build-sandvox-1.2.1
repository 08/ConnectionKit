#!/bin/bash

#
# created by TJT 2/25/2006
#

#
# NB: ***THIS IS A POTENTIALLY VERY DANGEROUS SCRIPT***
#
# Setting BUILD_ROOT incorrectly could destroy your filesystem.
# Setting XCODE_CACHE_DIR incorrectly could destroy your filesystem.
# Setting BUILD_INTERMEDIATE_DIR incorrectly could destroy your filesystem.
# Setting BUILD_RELEASE_DIR incorrectly could destroy your filesystem.
#
#     ***           YOU HAVE BEEN WARNED.           ***
#

### CHANGE THESE TO MATCH YOUR LOCAL CONFIGURATION ###
PROJECT_ROOT=/Volumes/Data/Users/ttalbot/Code/projects/1.2.1/Applications/Marvel

XCODE_CACHE_DIR=/Library/Caches/com.apple.Xcode.501
BUILD_INTERMEDIATE_DIR=/Volumes/Data/Build/Intermediates
BUILD_RELEASE_DIR=/Volumes/Data/Build/Products/Release

### DO NOT CHANGE THESE ###
BUILD_ROOT=/tmp/build-install-1.2.1
INFOPLIST_HEADER=$PROJECT_ROOT/../../BuildSettings.h

# NB: DSTROOT (derived from BUILD_ROOT) must be at least four (4)
# levels deep (total) to avoid creating strange build directories
# outside the BUILD_ROOT -- trust me on this!

# remove previous build (must be done with root privs)
if test -d ${BUILD_ROOT}
then
    echo "In order to build, we must first 'sudo rm ${BUILD_ROOT}'."
    echo "Check that directory carefully! Do you still wish to proceed? (Y/n): "
    read SHOULD_PROCEED
    if [ "XYZ${SHOULD_PROCEED}" = "XYZY" ]
    then
        echo "Removing ${BUILD_ROOT} ..."
        sudo rm -rf ${BUILD_ROOT}
    else
        exit 0
    fi
fi

echo ""
echo "Removing Xcode-specific directories, if necessary ..."

# remove Xcode's shared pre-compiled headers cache
if test -d ${XCODE_CACHE_DIR}
then
    echo "Removing ${XCODE_CACHE_DIR} ..."
    rm -rf ${XCODE_CACHE_DIR}
fi
        
# remove Xcode's intermediate build directory
if test -d ${BUILD_INTERMEDIATE_DIR}
then
    echo "Removing ${BUILD_INTERMEDIATE_DIR} ..."
    sudo rm -rf ${BUILD_INTERMEDIATE_DIR}
fi
        
# remove Xcode's Release build directory
if test -d ${BUILD_RELEASE_DIR}
then
    echo "Removing ${BUILD_RELEASE_DIR} ..."
    sudo rm -rf ${BUILD_RELEASE_DIR}
fi        

# build Sandvox
if test -d ${PROJECT_ROOT}
then
    echo ""
    echo "Building Marvel ..."
    pushd ${PROJECT_ROOT}
    echo ""
    
    xcodebuild \
        -target Marvel \
        -configuration Release \
        DEPLOYMENT_LOCATION=YES \
        DSTROOT=${BUILD_ROOT}/Sandvox/Deployment \
        INFOPLIST_OTHER_PREPROCESSOR_FLAGS="-C" \
        INFOPLIST_PREFIX_HEADER=${INFOPLIST_HEADER} \
        INFOPLIST_PREPROCESS=YES \
        install

    echo "Build complete."
    echo ""
    echo ""

# remove Swedish localizations
    echo "Removing Swedish localizations ..."
    pushd ${BUILD_ROOT}/Sandvox/Deployment
    echo ""
    
    sudo find . -name 'sv.lproj' -exec rm -rf {} \;
    
    echo "Removal complete."
   	echo ""
   	echo ""
    popd

# remove Xcode's shared pre-compiled headers cache, again
if test -d ${XCODE_CACHE_DIR}
then
    echo "If you want to go straight back to Xcode and Debug, you should"
    echo "remove ${XCODE_CACHE_DIR} first."
    echo "Shall I do that for you? (Y/n): "
    read SHOULD_PROCEED
    if [ "XYZ${SHOULD_PROCEED}" = "XYZY" ]
    then
        echo "Removing ${XCODE_CACHE_DIR} ..."
        rm -rf ${XCODE_CACHE_DIR}
    fi
fi

    popd
else
    echo "Did not find PROJECT_ROOT ( ${PROJECT_ROOT} )! Please set accordingly."
    exit 0
fi
